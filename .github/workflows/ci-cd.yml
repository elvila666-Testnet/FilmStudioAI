name: CI/CD Pipeline

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop

env:
  REGISTRY: gcr.io
  IMAGE_NAME: ai-film-studio

jobs:
  # Quality checks
  quality:
    runs-on: ubuntu-latest
    name: Code Quality & Linting
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "pnpm"

      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 10

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run TypeScript check
        run: pnpm exec tsc --noEmit

      - name: Run linter
        run: pnpm exec eslint . --ext .ts,.tsx --max-warnings 0 || true

      - name: Run Prettier check
        run: pnpm exec prettier --check . || true

  # Security scanning
  security:
    runs-on: ubuntu-latest
    name: Security Scanning
    steps:
      - uses: actions/checkout@v4

      - name: Run Snyk security scan
        uses: snyk/actions/node@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        continue-on-error: true

      - name: Dependency audit
        run: npm audit --audit-level=moderate || true

      - name: SAST scanning with semgrep
        uses: returntocorp/semgrep-action@v1
        with:
          config: >-
            p/security-audit
            p/owasp-top-ten
            p/typescript

  # Unit tests
  test:
    runs-on: ubuntu-latest
    name: Unit Tests
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: ai_film_studio_test
        options: >-
          --health-cmd="mysqladmin ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3
        ports:
          - 3306:3306

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "pnpm"

      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 10

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run unit tests
        run: pnpm test
        env:
          DATABASE_URL: mysql://root:root@localhost:3306/ai_film_studio_test
          NODE_ENV: test

      - name: Upload coverage
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage/coverage-final.json
          flags: unittests
          name: codecov-umbrella

  # Integration tests
  integration:
    runs-on: ubuntu-latest
    name: Integration Tests
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: ai_film_studio_test
        options: >-
          --health-cmd="mysqladmin ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3
        ports:
          - 3306:3306

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "pnpm"

      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 10

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run integration tests
        run: pnpm test:integration
        env:
          DATABASE_URL: mysql://root:root@localhost:3306/ai_film_studio_test
          NODE_ENV: test

  # Build Docker image
  build:
    runs-on: ubuntu-latest
    name: Build Docker Image
    needs: [quality, security, test, integration]
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop')
    permissions:
      contents: read
      id-token: write

    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v1
        with:
          workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
          service_account: ${{ secrets.WIF_SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v1

      - name: Configure Docker authentication
        run: gcloud auth configure-docker ${{ env.REGISTRY }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v4
        with:
          context: .
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ secrets.GCP_PROJECT_ID }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
            ${{ env.REGISTRY }}/${{ secrets.GCP_PROJECT_ID }}/${{ env.IMAGE_NAME }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # Deploy to staging
  deploy-staging:
    runs-on: ubuntu-latest
    name: Deploy to Staging
    needs: build
    if: github.ref == 'refs/heads/develop'
    permissions:
      contents: read
      id-token: write

    steps:
      - uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v1
        with:
          workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
          service_account: ${{ secrets.WIF_SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v1

      - name: Deploy to Cloud Run (Staging)
        run: |
          gcloud run deploy ai-film-studio-staging \
            --image=${{ env.REGISTRY }}/${{ secrets.GCP_PROJECT_ID }}/${{ env.IMAGE_NAME }}:${{ github.sha }} \
            --region=us-central1 \
            --platform=managed \
            --allow-unauthenticated \
            --set-env-vars="NODE_ENV=staging" \
            --project=${{ secrets.GCP_PROJECT_ID }}

      - name: Run smoke tests
        run: |
          STAGING_URL=$(gcloud run services describe ai-film-studio-staging \
            --region=us-central1 \
            --format='value(status.url)' \
            --project=${{ secrets.GCP_PROJECT_ID }})
          curl -f "$STAGING_URL/health/live" || exit 1

  # Deploy to production
  deploy-production:
    runs-on: ubuntu-latest
    name: Deploy to Production
    needs: build
    if: github.ref == 'refs/heads/main'
    permissions:
      contents: read
      id-token: write
    environment:
      name: production
      url: https://ai-film-studio.com

    steps:
      - uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v1
        with:
          workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
          service_account: ${{ secrets.WIF_SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v1

      - name: Deploy to Cloud Run (Production)
        run: |
          gcloud run deploy ai-film-studio \
            --image=${{ env.REGISTRY }}/${{ secrets.GCP_PROJECT_ID }}/${{ env.IMAGE_NAME }}:${{ github.sha }} \
            --region=us-central1 \
            --platform=managed \
            --allow-unauthenticated \
            --set-env-vars="NODE_ENV=production" \
            --project=${{ secrets.GCP_PROJECT_ID }} \
            --no-traffic

      - name: Run smoke tests
        run: |
          PROD_URL=$(gcloud run services describe ai-film-studio \
            --region=us-central1 \
            --format='value(status.url)' \
            --project=${{ secrets.GCP_PROJECT_ID }})
          curl -f "$PROD_URL/health/live" || exit 1

      - name: Gradual traffic shift (10% -> 50% -> 100%)
        run: |
          for TRAFFIC in 10 50 100; do
            gcloud run services update-traffic ai-film-studio \
              --to-revisions=LATEST=$TRAFFIC \
              --region=us-central1 \
              --project=${{ secrets.GCP_PROJECT_ID }}
            sleep 300  # Wait 5 minutes between traffic shifts
          done

      - name: Create GitHub Release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v${{ github.run_number }}
          release_name: Release v${{ github.run_number }}
          body: |
            Deployed to production
            Image: ${{ env.REGISTRY }}/${{ secrets.GCP_PROJECT_ID }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
          draft: false
          prerelease: false

  # Post-deployment monitoring
  monitor:
    runs-on: ubuntu-latest
    name: Post-Deployment Monitoring
    needs: deploy-production
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Check Cloud Run health
        run: |
          PROD_URL=$(gcloud run services describe ai-film-studio \
            --region=us-central1 \
            --format='value(status.url)' \
            --project=${{ secrets.GCP_PROJECT_ID }})
          
          # Check health endpoint
          curl -f "$PROD_URL/health" || exit 1
          
          # Check readiness
          curl -f "$PROD_URL/health/ready" || exit 1

      - name: Verify error rates
        run: |
          # Check Cloud Logging for error rate
          # This would integrate with Cloud Monitoring API
          echo "Monitoring error rates..."

      - name: Verify performance metrics
        run: |
          # Check Cloud Monitoring for p95 latency
          # This would integrate with Cloud Monitoring API
          echo "Monitoring performance metrics..."
